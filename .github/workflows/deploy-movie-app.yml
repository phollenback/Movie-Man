# Push code to existing App Service. Terraform sets up infra.
# Triggers: push to app-service (front/), or manual

name: Deploy Movie-App (App Service)

on:
  push:
    branches:
      - app-service
    paths:
      - 'front/**'
      - 'api/**'
      - '.github/workflows/deploy-movie-app.yml'
  workflow_dispatch:

env:
  RESOURCE_GROUP: movie-man-app-rg
  WEBAPP_NAME: movieman
  FUNCTIONS_APP_NAME: movieman-api
  ACR_NAME: moviemanacr
  IMAGE_NAME: movie-man-front
  FRONTEND_URL: https://movieman.azurewebsites.net

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Deploy API
        run: |
          cd api
          npm install --omit=dev
          zip -r ../api.zip . -x "*.git*" -x "local.settings.json" -x "*.example"
          az functionapp deployment source config-zip \
            -g ${{ env.RESOURCE_GROUP }} \
            -n ${{ env.FUNCTIONS_APP_NAME }} \
            --src ../api.zip

      - name: Log in to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push frontend image
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_URI=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:$IMAGE_TAG
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          docker build -t $IMAGE_URI -f front/Dockerfile front/ \
            --build-arg REACT_APP_GIT_REPO=${{ github.repository }} \
            --build-arg REACT_APP_GIT_BRANCH=$BRANCH_NAME \
            --build-arg REACT_APP_ENTRA_CLIENT_ID=${{ secrets.ENTRA_CLIENT_ID }} \
            --build-arg REACT_APP_ENTRA_TENANT_ID=${{ secrets.ENTRA_TENANT_ID || 'common' }} \
            --build-arg REACT_APP_REDIRECT_URI=${{ env.FRONTEND_URL }} \
            --build-arg REACT_APP_OMDB_API_KEY=${{ secrets.OMDB_API_KEY }} \
            --build-arg REACT_APP_API_URL=https://movieman-api.azurewebsites.net/api
          docker tag $IMAGE_URI ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          docker push $IMAGE_URI
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

      - name: Update Web App
        run: |
          az webapp config container set \
            -g ${{ env.RESOURCE_GROUP }} \
            -n ${{ env.WEBAPP_NAME }} \
            --docker-custom-image-name ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
