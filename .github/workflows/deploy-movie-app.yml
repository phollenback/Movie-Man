# Deploy movie-app (App Service) to Azure
# Trigger: push to main or workflow_dispatch
# Deploys: Frontend (App Service) + API (Azure Functions)

name: Deploy Movie-App (App Service)

on:
  push:
    branches:
      - main
      - dev-azure
    paths:
      - 'front/**'
      - 'api/**'
      - '.github/workflows/deploy-movie-app.yml'
  workflow_dispatch:

env:
  RESOURCE_GROUP: movie-man-app-rg
  AZURE_WEBAPP_NAME: movieman
  FUNCTIONS_APP_NAME: movieman-api
  ACR_NAME: moviemanacr
  IMAGE_NAME: movie-man-front

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.ENTRA_CLIENT_ID }}" ]; then
            echo "::error::ENTRA_CLIENT_ID secret is not set."
            exit 1
          fi
          if [ -z "${{ secrets.OMDB_API_KEY }}" ]; then
            echo "::error::OMDB_API_KEY secret is not set."
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Validate Terraform (movie-app)
        run: |
          cd movie-app/terraform
          terraform init -input=false
          terraform validate

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Azure resources exist
        run: |
          az group show --name ${{ env.RESOURCE_GROUP }} --output none || {
            echo "::error::Resource group ${{ env.RESOURCE_GROUP }} not found. Run terraform apply first."
            exit 1
          }

      - name: Deploy API (Azure Functions)
        run: |
          cd api
          npm install --production
          zip -r ../api.zip . -x "*.git*" -x "local.settings.json" -x "*.example"
          az functionapp deployment source config-zip \
            -g ${{ env.RESOURCE_GROUP }} \
            -n ${{ env.FUNCTIONS_APP_NAME }} \
            --src ../api.zip

      - name: Log in to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push Docker image (frontend)
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_URI=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:$IMAGE_TAG
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          docker build -t $IMAGE_URI -f front/Dockerfile front/ \
            --build-arg REACT_APP_GIT_REPO=${{ github.repository }} \
            --build-arg REACT_APP_GIT_BRANCH=$BRANCH_NAME \
            --build-arg REACT_APP_ENTRA_CLIENT_ID=${{ secrets.ENTRA_CLIENT_ID }} \
            --build-arg REACT_APP_ENTRA_TENANT_ID=${{ secrets.ENTRA_TENANT_ID || 'common' }} \
            --build-arg REACT_APP_REDIRECT_URI=https://movieman.azurewebsites.net \
            --build-arg REACT_APP_OMDB_API_KEY=${{ secrets.OMDB_API_KEY }} \
            --build-arg REACT_APP_API_URL=https://movieman-api.azurewebsites.net/api
          docker tag $IMAGE_URI ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          docker push $IMAGE_URI
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to App Service (frontend)
        run: |
          IMAGE_URI=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          az webapp config container set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --docker-custom-image-name $IMAGE_URI
          az webapp restart \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }}
