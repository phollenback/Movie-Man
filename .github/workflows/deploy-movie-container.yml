# Deploy movie-container (ACA) to Azure
# Trigger: workflow_dispatch only (manual) - infra already running
# Deploys: Frontend (Container App) + API (Azure Functions)

name: Deploy Movie-Container (ACA)

on:
  workflow_dispatch:

env:
  RESOURCE_GROUP: movie-man-container-rg
  CONTAINER_APP_NAME: moviemanc
  FUNCTIONS_APP_NAME: moviemanc-api
  ACR_NAME: moviemancacr
  IMAGE_NAME: movie-man-front
  FRONTEND_URL: https://moviemanc.calmforest-70405e10.westus2.azurecontainerapps.io

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.ENTRA_CLIENT_ID }}" ]; then
            echo "::error::ENTRA_CLIENT_ID secret is not set."
            exit 1
          fi
          if [ -z "${{ secrets.OMDB_API_KEY }}" ]; then
            echo "::error::OMDB_API_KEY secret is not set."
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Validate Terraform (movie-container)
        run: |
          cd movie-container/terraform
          terraform init -input=false
          terraform validate

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate ACA is running
        run: |
          az group show --name ${{ env.RESOURCE_GROUP }} --output none || {
            echo "::error::Resource group ${{ env.RESOURCE_GROUP }} not found. Run terraform apply first."
            exit 1
          }
          STATUS=$(az containerapp show --name ${{ env.CONTAINER_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.provisioningState" -o tsv 2>/dev/null || echo "NotFound")
          if [ "$STATUS" != "Succeeded" ]; then
            echo "::error::Container App ${{ env.CONTAINER_APP_NAME }} not ready (status: $STATUS). Run terraform apply first."
            exit 1
          fi
          echo "ACA is running, proceeding with code deploy."

      - name: Deploy API (Azure Functions)
        run: |
          cd api
          npm install --production
          zip -r ../api.zip . -x "*.git*" -x "local.settings.json" -x "*.example"
          az functionapp deployment source config-zip \
            -g ${{ env.RESOURCE_GROUP }} \
            -n ${{ env.FUNCTIONS_APP_NAME }} \
            --src ../api.zip

      - name: Log in to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push Docker image (frontend)
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_URI=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:$IMAGE_TAG
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          docker build -t $IMAGE_URI -f front/Dockerfile front/ \
            --build-arg REACT_APP_GIT_REPO=${{ github.repository }} \
            --build-arg REACT_APP_GIT_BRANCH=$BRANCH_NAME \
            --build-arg REACT_APP_ENTRA_CLIENT_ID=${{ secrets.ENTRA_CLIENT_ID }} \
            --build-arg REACT_APP_ENTRA_TENANT_ID=${{ secrets.ENTRA_TENANT_ID || 'common' }} \
            --build-arg REACT_APP_REDIRECT_URI=${{ env.FRONTEND_URL }} \
            --build-arg REACT_APP_OMDB_API_KEY=${{ secrets.OMDB_API_KEY }} \
            --build-arg REACT_APP_API_URL=https://moviemanc-api.azurewebsites.net/api
          docker tag $IMAGE_URI ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          docker push $IMAGE_URI
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

      - name: Update Container App (frontend)
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
