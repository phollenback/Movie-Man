# Push code to existing ACA. Terraform sets up infra.
# Triggers: push to container-service (front/, api/), or manual

name: Deploy Movie-Container (ACA)

on:
  push:
    branches:
      - container-service
    paths:
      - 'front/**'
      - 'api/**'
      - '.github/workflows/deploy-movie-container.yml'
  workflow_dispatch:

concurrency:
  group: deploy-movie-container
  cancel-in-progress: true

env:
  RESOURCE_GROUP: movie-man-container-rg
  CONTAINER_APP_NAME: moviemanc
  FUNCTIONS_APP_NAME: moviemanc-api
  ACR_NAME: moviemancacr
  IMAGE_NAME: movie-man-front
  FRONTEND_URL: https://moviemanc.ambitioustree-615c59f1.westus2.azurecontainerapps.io

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Deploy API
        run: |
          cd api
          npm install --omit=dev
          zip -r ../api.zip . -x "*.git*" -x "local.settings.json" -x "*.example"
          az functionapp deployment source config-zip \
            -g ${{ env.RESOURCE_GROUP }} \
            -n ${{ env.FUNCTIONS_APP_NAME }} \
            --src ../api.zip

      - name: Log in to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push frontend image
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_URI=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:$IMAGE_TAG
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          docker build -t $IMAGE_URI -f front/Dockerfile front/ \
            --build-arg REACT_APP_GIT_REPO=${{ github.repository }} \
            --build-arg REACT_APP_GIT_BRANCH=$BRANCH_NAME \
            --build-arg REACT_APP_ENTRA_CLIENT_ID=${{ secrets.ENTRA_CLIENT_ID }} \
            --build-arg REACT_APP_ENTRA_TENANT_ID=${{ secrets.ENTRA_TENANT_ID || 'common' }} \
            --build-arg REACT_APP_REDIRECT_URI=${{ env.FRONTEND_URL }} \
            --build-arg REACT_APP_OMDB_API_KEY=${{ secrets.OMDB_API_KEY }} \
            --build-arg REACT_APP_API_URL=https://moviemanc-api.azurewebsites.net/api
          docker tag $IMAGE_URI ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          docker push $IMAGE_URI
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

      - name: Update Container App
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
